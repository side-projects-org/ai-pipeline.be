# í˜„ì¬ í´ë”ì™€ src í´ë”(ë£¨íŠ¸ í´ë”) ê²½ë¡œ
SRC_ROOT_PATH := $(shell pwd | sed 's|\(/src\).*|\1|')
CURR_PATH := $(shell pwd)
CURR_FOLDER_NAME := $(shell basename $(CURR_PATH))

# íŒŒì¼ ê²½ë¡œ ì„¤ì •
BUILD_ZIP := build.zip
BUILD_SHA := build.sha
BUILD_SHA_TMP := build.sha.tmp

# SHA-256 í•´ì‹œê°’ ìƒì„± í•¨ìˆ˜
define generate_sha
	@echo "Generating SHA-256 hash for $(1)..."
	@shasum -a 256 $(1) | awk '{ print $$1 }' > $(2)
endef

# SHA-256 í•´ì‹œê°’ ë¹„êµ í•¨ìˆ˜
define compare_sha
	@echo "Comparing SHA-256 hashes..."
	@if [ -f $(1) ] && [ -f $(2) ]; then \
		if cmp -s $(1) $(2); then \
			echo "No changes detected. Deployment skipped."; \
			exit 0; \
		else \
			echo "Changes etected. Proceeding with deployment..."; \
		fi \
	else \
		echo "SHA files mis sing or incomplete. Proceeding with deployment..."; \
	fi
endef

# ì¶œë ¥í•  ë³€ìˆ˜
.PHONY: print_path
print_path:
	@echo 'ë£¨íŠ¸ ë””ë ‰í† ë¦¬: $(SRC_ROOT_PATH)'
	@echo 'í˜„ì¬ ë””ë ‰í† ë¦¬: $(CURR_PATH)'


define build_sha256
	@echo "	â–¶ Call func build_sha256(file_name)"
	@echo "	Searching files to include in hash..."
	@find . -type f \
		! -path "./code/*" \
		! -path "*/__pycache__/*" \
		! -name "*.sha" \
		! -name "*.zip" \
		! -name "*.tmp" \
		! -name "*.bak" \
		! -name "Makefile*" \
		-print0 \
	| xargs -0 shasum -a 256 \
	| awk '{ print $$1 }' \
	| shasum -a 256 \
	| awk '{ print $$1 }' > $(1);

	@echo "	Hash code: $$(cat $(1))"
	@echo "	âœ… func ended. SHA-256 written in file named '$(1)'\n"
endef

.PHONY: zip-src
zip-src:
	@echo "â–¶ Generating SHA256 snapshot for current state..."
	$(call build_sha256,$(BUILD_SHA_TMP))

	@echo "â–¶ Comparing with existing $(BUILD_SHA)..."
	@sh -c '\
		CURR_HASH=$$(cat "$(BUILD_SHA_TMP)" 2>/dev/null); \
		echo "  â†’ SHA256_TMP = $$CURR_HASH"; \
		BUILD_FLAG=false; \
		if [ -f "$(BUILD_SHA)" ]; then \
			OLD_HASH=$$(cat "$(BUILD_SHA)"); \
			if [ "$$CURR_HASH" = "$$OLD_HASH" ]; then \
				echo "â¸ï¸ No changes detected. Deployment skipped."; \
			else \
				echo "ğŸ”„ Changes detected!"; \
				mv $(BUILD_SHA_TMP) $(BUILD_SHA); \
				echo "ğŸ’¾ Updated '$(BUILD_SHA)' with new checksum."; \
				BUILD_FLAG=true; \
			fi; \
		else \
			echo "ğŸ†• First time deployment!"; \
			mv $(BUILD_SHA_TMP) $(BUILD_SHA); \
			echo "ğŸ’¾ Created '$(BUILD_SHA)' with new checksum."; \
			BUILD_FLAG=true; \
		fi; \
		\
		if [ "$$BUILD_FLAG" = "true" ]; then \
			echo "â–¶ Proceeding with deployment..."; \
			zip -r $(BUILD_ZIP) ./ \
				-x "*.zip" "*.sha*" "Makefile*" "code/*" "*/__pycache__/*"; \
			echo "âœ… Build zip completed."; \
		fi; \
		\
		rm -f ${BUILD_SHA_TMP}; \'


# zip íŒŒì¼ ì••ì¶• í•´ì œ
.PHONY: unzip
unzip:
	@echo 'zip íŒŒì¼ ì••ì¶• í•´ì œ'
	@if [ -d code ]; then \
		echo 'code í´ë”ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ì‚­ì œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.'; \
		rm -rf code; \
	else \
		echo 'code í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; \
	fi
	mkdir -p "./code"
	unzip -o "$(BUILD_ZIP)" -d "./code"
	make tree

# ë””ë ‰í† ë¦¬ êµ¬ì¡° ì¶œë ¥
.PHONY: tree
tree:
	@echo 'ë””ë ‰í† ë¦¬ êµ¬ì¡° ì¶œë ¥'
	tree -L 2

